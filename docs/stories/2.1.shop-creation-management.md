# Story 2.1: Shop Creation & Management

<!-- Powered by BMAD™ Core -->

## Status
Ready for Review

## Story
**As an** admin,
**I want** to create and manage multiple shops,
**so that** I can track finances for all my spare parts locations.

## Acceptance Criteria
1. Shop creation form with Arabic and English name fields
2. Automatic creation of shop-specific sub-accounts with proper suffixes (e.g., sales-downtown, المبيعات-وسط المدينة)
3. Default accounts created: direct-sales-{shop}, direct-purchase-{shop}
4. Shop listing page showing all shops with edit/delete options
5. Shop assignment to users during shop creation
6. Validation preventing duplicate shop names
7. Soft delete implementation to preserve historical data
8. Shop status (active/inactive) management

## Tasks / Subtasks

- [x] Task 1: Create Shop Data Model and tRPC Router (AC: 1, 6, 8)
  - [x] Extend Shop Prisma model with required fields for bilingual naming
  - [x] Create tRPC shop router with CRUD procedures (create, list, update, delete)
  - [x] Implement soft delete logic using isActive field
  - [x] Add validation middleware for duplicate shop names
  - [x] Create shop status management procedures
  - [x] Write unit tests for shop router procedures

- [x] Task 2: Implement Shop Account Auto-Generation System (AC: 2, 3)
  - [x] Create account generation service for shop-specific accounts
  - [x] Implement bilingual suffix generation for sub-accounts
  - [x] Generate default accounts: direct-sales-{shop}, direct-purchase-{shop}
  - [x] Ensure proper account hierarchy creation with shop context
  - [x] Add account code generation with shop-specific prefixes
  - [x] Write unit tests for account auto-generation logic

- [x] Task 3: Build Shop Creation Form Component (AC: 1, 5, 6)
  - [x] Create ShopForm component with Arabic/English name fields
  - [x] Implement form validation using React Hook Form + Zod
  - [x] Add user assignment dropdown during shop creation
  - [x] Integrate duplicate name validation with real-time feedback
  - [x] Add Arabic RTL form layout support
  - [x] Write component tests for form validation and submission

- [x] Task 4: Create Shop Management Dashboard (AC: 4, 7, 8)
  - [x] Build ShopList component displaying all shops in table format
  - [x] Implement edit/delete actions with proper authorization
  - [x] Add soft delete confirmation dialogs
  - [x] Create shop status toggle functionality (active/inactive)
  - [x] Add bilingual shop name display with proper RTL support
  - [x] Implement search/filter functionality for shop list

- [x] Task 5: Setup Shop Context and Authorization (AC: 5)
  - [x] Create shop context provider for current shop state
  - [x] Implement shop-based authorization middleware
  - [x] Add shop selection functionality for admin users
  - [x] Ensure multi-tenant data isolation per shop
  - [x] Create shop switching interface component
  - [x] Add shop context to tRPC procedures

- [x] Task 6: Integration Testing and Validation (AC: 1-8)
  - [x] Write integration tests for complete shop creation flow
  - [x] Test account auto-generation with bilingual naming
  - [x] Test soft delete functionality and data preservation
  - [x] Validate duplicate name prevention across Arabic/English
  - [x] Test shop status management and user assignment
  - [x] Create E2E tests for shop management workflows

## Dev Notes

### Previous Story Insights
**From Story 1.5 (Health Check):** [Source: docs/stories/1.5.basic-health-check-landing-page.md]
- tRPC client setup is established and functional
- Arabic RTL layout components are available (RTL Provider, Language Toggle)
- Authentication system and user session management is operational
- Form validation patterns using React Hook Form + Zod are established
- Mobile app structure with Expo Router is initialized

### Data Models
**Shop Model** [Source: architecture/data-models.md#shop]
- id: string (UUID) - Unique shop identifier
- nameAr: string - Arabic shop name (primary)
- nameEn: string - English shop name (secondary)
- code: string - Unique shop code for account suffixes
- isActive: boolean - Shop operational status (for soft delete)
- ownerId: string - Reference to admin user
- Relationships: Has many Users, Accounts, FinancialYears, Transactions

**Account Model for Auto-Generation** [Source: architecture/data-models.md#account]
- Shop-specific accounts with bilingual naming and proper hierarchy
- AccountType enum: ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE
- level: number (1=main, 2=sub, 3=detail) for hierarchy
- parentId: string for account relationships
- shopId: string for multi-tenant isolation
- isSystemAccount: boolean (auto-generated accounts)

**User Model for Assignment** [Source: architecture/data-models.md#user]
- role: UserRole (ADMIN or USER) for authorization
- shopId: string for user-shop assignment
- Admins can be assigned to multiple shops via ownership

### API Specifications
**Shop tRPC Router** [Source: architecture/backend-architecture.md]
```typescript
// apps/api/src/server/routers/shop.ts
export const shopRouter = router({
  create: protectedProcedure
    .input(z.object({
      nameAr: z.string().min(1),
      nameEn: z.string().min(1),
      code: z.string().min(1),
      assignedUserIds: z.array(z.string()).optional()
    }))
    .mutation(async ({ input, ctx }) => {
      // Create shop with account generation
    }),

  list: protectedProcedure
    .query(async ({ ctx }) => {
      // Return shops based on user role
    }),

  update: protectedProcedure
    .input(z.object({ id: z.string(), ...shopData }))
    .mutation(async ({ input, ctx }) => {
      // Update shop with validation
    }),

  softDelete: protectedProcedure
    .input(z.object({ id: z.string() }))
    .mutation(async ({ input, ctx }) => {
      // Soft delete via isActive = false
    })
});
```

**Account Auto-Generation Service** [Source: architecture/data-models.md#account]
- Generate default accounts: direct-sales-{shopCode}, direct-purchase-{shopCode}
- Bilingual account names with Arabic/English suffixes
- Proper account hierarchy with shop context for data isolation

### Component Specifications
**Shop Form Component** [Source: architecture/frontend-architecture.md#component-organization]
- Location: `apps/web/src/components/features/shops/ShopForm.tsx`
- Use React Hook Form + Zod for validation
- Arabic/English name fields with RTL layout support
- User assignment multi-select component
- Real-time duplicate validation

**Shop Management Components** [Source: architecture/frontend-architecture.md#component-organization]
- ShopList: `apps/web/src/components/features/shops/ShopList.tsx`
- ShopCard: `apps/web/src/components/features/shops/ShopCard.tsx`
- Shop routing: `apps/web/src/app/(dashboard)/shops/` directory
- Use shadcn/ui components (Table, Card, Dialog, Form)

### File Locations
**Backend Files** [Source: architecture/unified-project-structure.md]
- Shop router: `apps/api/src/server/routers/shop.ts`
- Shop service: `apps/api/src/server/services/shop.service.ts`
- Account generation: `apps/api/src/server/services/account-generation.service.ts`
- Shop validation: `packages/shared/src/validators/shop.validator.ts`

**Frontend Files** [Source: architecture/unified-project-structure.md]
- Shop pages: `apps/web/src/app/(dashboard)/shops/`
- Shop components: `apps/web/src/components/features/shops/`
- Shop store: `apps/web/src/stores/shop.store.ts`
- Shop types: `packages/shared/src/types/shop.ts`

**Database Schema** [Source: architecture/database-schema.md]
- Shop table already defined in Prisma schema
- Account table with shopId foreign key for multi-tenancy
- User table with shopId for assignments

### Testing Requirements
**Shop Management Testing** [Source: architecture/testing-strategy.md]
- Unit tests: Shop router procedures, account generation service
- Integration tests: Complete shop creation flow with account generation
- Component tests: ShopForm validation, ShopList functionality
- E2E tests: Arabic/English name handling, soft delete workflows
- Test file locations: `apps/web/tests/unit/components/shops/`, `apps/api/tests/unit/routers/`

**Multi-tenant Testing** [Source: architecture/coding-standards.md#multi-tenant-isolation]
- Every database query must include shopId filtering
- Test data isolation between shops
- Validate shop context in all tRPC procedures

### Technical Constraints
**Multi-tenant Data Isolation** [Source: architecture/coding-standards.md]
- All database queries must include shopId filtering
- Shop context must be passed through tRPC procedures
- User authorization based on shop assignments

**Arabic Support Requirements** [Source: architecture/coding-standards.md]
- All user-facing strings must have Arabic translations
- RTL layout support for form components
- Arabic text validation and display

**Type Safety** [Source: architecture/coding-standards.md]
- Define types in packages/shared and import
- Use tRPC client for type-safe API calls
- No direct HTTP calls - always use tRPC service layer

## Testing

### Unit Tests
- Shop router procedures validation and business logic
- Account auto-generation service functionality
- Shop form component validation and submission
- Soft delete logic and status management

### Integration Tests
- Complete shop creation workflow with account generation
- User assignment and authorization flows
- Bilingual name handling and duplicate prevention
- Multi-tenant data isolation validation

### E2E Tests
- Shop creation form with Arabic/English input
- Shop management dashboard operations
- User assignment and shop context switching
- Soft delete and status management workflows

Test files should be located according to testing strategy:
- Frontend: `apps/web/tests/unit/components/shops/`
- Backend: `apps/api/tests/unit/routers/shop.test.ts`
- E2E: `apps/web/tests/e2e/shops.spec.ts`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-17 | 1.0 | Initial story creation with complete technical context | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- No critical issues encountered during implementation
- All validation requirements successfully implemented
- Multi-tenant isolation properly configured
- Arabic RTL support fully integrated

### Completion Notes
Story 2.1 has been successfully implemented with all acceptance criteria met:

1. ✅ Shop creation form with Arabic and English name fields
2. ✅ Automatic creation of shop-specific sub-accounts with proper suffixes
3. ✅ Default accounts created: direct-sales-{shop}, direct-purchase-{shop}
4. ✅ Shop listing page showing all shops with edit/delete options
5. ✅ Shop assignment to users during shop creation
6. ✅ Validation preventing duplicate shop names
7. ✅ Soft delete implementation to preserve historical data
8. ✅ Shop status (active/inactive) management

All tasks completed successfully:
- Task 1: Shop Data Model and tRPC Router ✅
- Task 2: Shop Account Auto-Generation System ✅
- Task 3: Shop Creation Form Component ✅
- Task 4: Shop Management Dashboard ✅
- Task 5: Shop Context and Authorization ✅
- Task 6: Integration Testing and Validation ✅

### File List

**Backend Files Created/Modified:**
- `apps/api/prisma/schema.prisma` - Added `code` field to Shop model, `isSystemAccount` to Account model
- `apps/api/src/server/routers/shop.ts` - Complete shop tRPC router with CRUD operations
- `apps/api/src/server/routers/index.ts` - Added shop router to main router
- `apps/api/src/server/services/shop.service.ts` - Shop business logic and validation
- `apps/api/src/server/services/account-generation.service.ts` - Auto-generation of shop accounts
- `apps/api/tests/unit/routers/shop.test.ts` - Unit tests for shop router
- `apps/api/tests/unit/services/account-generation.test.ts` - Unit tests for account generation

**Frontend Files Created:**
- `apps/web/src/components/features/shops/ShopForm.tsx` - Shop creation/edit form with bilingual support
- `apps/web/src/components/features/shops/ShopList.tsx` - Shop management dashboard with search/filter
- `apps/web/src/components/features/shops/ShopCard.tsx` - Individual shop display component
- `apps/web/src/components/features/shops/ShopSelector.tsx` - Shop selection dropdown component
- `apps/web/src/app/dashboard/shops/page.tsx` - Main shops management page
- `apps/web/src/stores/shop.store.ts` - Zustand shop state management
- `apps/web/src/components/providers/ShopProvider.tsx` - Shop context provider
- `apps/web/src/components/auth/ShopGuard.tsx` - Shop authorization HOC and guards

**Shared Package Files Created:**
- `packages/shared/src/types/shop.ts` - Shop TypeScript interfaces and constants
- `packages/shared/src/validators/shop.ts` - Zod validation schemas for shops
- `packages/shared/src/index.ts` - Export shop types and validators

**Test Files Created:**
- `apps/web/tests/unit/components/shops/ShopForm.test.tsx` - ShopForm component tests
- `apps/web/tests/unit/components/shops/ShopList.test.tsx` - ShopList component tests
- `apps/web/tests/unit/stores/shop.store.test.ts` - Shop store unit tests
- `apps/web/tests/integration/shop-creation-flow.test.tsx` - Integration tests
- `apps/web/tests/e2e/shops.spec.ts` - End-to-end Playwright tests

## QA Results

### Review Date: 2025-01-17

### Reviewed By: Quinn (Test Architect)

### Review Summary
Story 2.1 has been successfully implemented with all 8 acceptance criteria met:
- ✅ Shop creation form with Arabic and English name fields
- ✅ Automatic creation of shop-specific sub-accounts with proper suffixes
- ✅ Default accounts created: direct-sales-{shop}, direct-purchase-{shop}
- ✅ Shop listing page showing all shops with edit/delete options
- ✅ Shop assignment to users during shop creation
- ✅ Validation preventing duplicate shop names
- ✅ Soft delete implementation to preserve historical data
- ✅ Shop status (active/inactive) management

### Implementation Quality
- All 6 tasks completed successfully
- Comprehensive file list provided in Dev Agent Record
- Test files created for unit, integration, and E2E testing
- Multi-tenant isolation properly implemented
- Arabic RTL support fully integrated
- Type safety maintained with shared types/validators

### Gate Status

Gate: PASS → docs/qa/gates/2.1-shop-creation-management.yml