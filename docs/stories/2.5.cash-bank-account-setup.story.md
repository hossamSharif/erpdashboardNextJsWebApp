# Story 2.5: Cash & Bank Account Setup

## Status
done


## Story
**As an** admin,
**I want** to configure cash and bank accounts with opening balances,
**so that** financial tracking starts from accurate baseline.

## Acceptance Criteria
1: Cash account creation per shop with opening balance
2: Bank account creation per shop with opening balance
3: Multiple bank accounts per shop support
4: Account number and bank details storage
5: Opening balance validation (can be negative for overdraft)
6: Balance history tracking
7: Account reconciliation markers
8: Default payment account selection per shop

## Tasks / Subtasks

- [x] Create cash and bank account data models (AC: 1, 2, 3, 4)
  - [x] Design CashAccount and BankAccount Prisma models
  - [x] Add account type enum for cash/bank/credit card accounts
  - [x] Create database migration for new models
  - [x] Add relationship with Shop model for multi-tenant isolation
  - [x] Include balance history tracking model

- [x] Implement cash and bank account API endpoints (AC: 1, 2, 3, 4, 5, 8)
  - [x] Create `createCashAccount` tRPC procedure for shop cash accounts
  - [x] Create `createBankAccount` tRPC procedure for shop bank accounts
  - [x] Create `updateAccountBalance` tRPC procedure with history tracking
  - [x] Create `setDefaultPaymentAccount` tRPC procedure per shop
  - [x] Add Zod validation schemas for account creation and balance updates
  - [x] Implement opening balance validation (allow negative values)

- [x] Implement database repositories and services (AC: 1, 2, 3, 5, 6, 7)
  - [x] Create CashAccountRepository with CRUD operations
  - [x] Create BankAccountRepository with CRUD operations
  - [x] Implement BalanceHistoryService for audit trail
  - [x] Add reconciliation status tracking functionality
  - [x] Ensure proper shopId filtering for multi-tenant isolation

- [x] Create admin interface for cash/bank account management (AC: 1, 2, 3, 4, 8)
  - [x] Design cash account creation form with Arabic/English labels
  - [x] Design bank account creation form with account details fields
  - [x] Create account listing component showing cash and bank accounts
  - [x] Add default payment account selection interface
  - [x] Implement balance update form with validation
  - [x] Add account status and reconciliation marker display

- [x] Implement account balance management features (AC: 5, 6, 7)
  - [x] Create balance adjustment functionality with audit logging
  - [x] Implement balance history view component
  - [x] Add reconciliation workflow for bank accounts
  - [x] Create balance validation with negative balance support (overdraft)

- [x] Add comprehensive testing (All ACs)
  - [x] Unit tests for cash and bank account API endpoints
  - [x] Unit tests for balance validation and history tracking
  - [x] Integration tests for account creation workflow
  - [x] E2E tests for complete cash/bank account management
  - [x] Test bilingual interface and RTL layout support

## Dev Notes

### Previous Story Insights
From Story 2.4 (Opening & Ending Stock Value Management):
- Stock value management patterns established with audit logging
- Financial year association patterns working properly
- Multi-tenant isolation patterns implemented successfully
- Bilingual UI patterns (Arabic/English) with RTL support implemented
- Decimal precision handling for financial values using @db.Decimal(15, 2)

### Data Models
**New Models Required** [Based on story requirements and existing Account model patterns]:

**CashAccount Model** [Extending existing Account patterns from data-models.md]:
- `id: string (UUID)` - Unique identifier
- `nameAr: string` - Arabic account name
- `nameEn: string` - English account name
- `shopId: string` - Multi-tenant shop reference
- `openingBalance: Decimal` - Initial balance (can be negative)
- `currentBalance: Decimal` - Real-time balance
- `isActive: boolean` - Account status
- `isDefault: boolean` - Default payment account flag
- `createdAt: DateTime` - Creation timestamp
- `updatedAt: DateTime` - Last modification timestamp

**BankAccount Model** [Extending existing Account patterns from data-models.md]:
- `id: string (UUID)` - Unique identifier
- `nameAr: string` - Arabic account name
- `nameEn: string` - English account name
- `accountNumber: string` - Bank account number
- `bankName: string` - Bank institution name
- `iban: string` - International Bank Account Number
- `shopId: string` - Multi-tenant shop reference
- `openingBalance: Decimal` - Initial balance (can be negative for overdraft)
- `currentBalance: Decimal` - Real-time balance
- `isActive: boolean` - Account status
- `isDefault: boolean` - Default payment account flag
- `createdAt: DateTime` - Creation timestamp
- `updatedAt: DateTime` - Last modification timestamp

**BalanceHistory Model** [For audit trail as seen in stock value management]:
- `id: string (UUID)` - Unique identifier
- `accountType: enum` - CASH or BANK
- `accountId: string` - Reference to cash or bank account
- `previousBalance: Decimal` - Balance before change
- `newBalance: Decimal` - Balance after change
- `changeAmount: Decimal` - Amount of change
- `changeReason: string` - Reason for balance adjustment
- `userId: string` - User who made the change
- `shopId: string` - Multi-tenant isolation
- `createdAt: DateTime` - Change timestamp

**Database Schema** [Source: architecture/database-schema.md patterns]:
```prisma
model CashAccount {
  id             String    @id @default(uuid())
  nameAr         String
  nameEn         String
  shopId         String
  openingBalance Decimal   @db.Decimal(15, 2)
  currentBalance Decimal   @db.Decimal(15, 2)
  isActive       Boolean   @default(true)
  isDefault      Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  shop           Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  balanceHistory BalanceHistory[]

  @@unique([shopId, isDefault])
  @@index([shopId])
}

model BankAccount {
  id             String    @id @default(uuid())
  nameAr         String
  nameEn         String
  accountNumber  String
  bankName       String
  iban           String?
  shopId         String
  openingBalance Decimal   @db.Decimal(15, 2)
  currentBalance Decimal   @db.Decimal(15, 2)
  isActive       Boolean   @default(true)
  isDefault      Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  shop           Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  balanceHistory BalanceHistory[]

  @@unique([shopId, isDefault])
  @@index([shopId])
}
```

### API Specifications
**tRPC Router Structure** [Source: architecture/backend-architecture.md]:
- Admin procedures use `adminProcedure` for role-based access control
- All procedures must include shop context validation using ShopContext
- Input validation using Zod schemas with type safety
- Multi-tenant isolation enforced in all database queries
- Follow existing patterns from FinancialYear router

**New Router: cashBankRouter** [Following existing router patterns]:
- `createCashAccount` - Admin-only procedure for cash account creation
- `createBankAccount` - Admin-only procedure for bank account creation
- `updateAccountBalance` - Admin procedure for balance adjustments
- `setDefaultPaymentAccount` - Admin procedure for default account selection
- `getCashAccounts` - Retrieve all cash accounts for shop
- `getBankAccounts` - Retrieve all bank accounts for shop
- `getBalanceHistory` - Retrieve balance change audit trail

### Component Specifications
**Admin Dashboard Context** [Source: architecture/unified-project-structure.md]:
- Location: `apps/web/src/components/admin/cash-bank/` for specialized components
- Form handling: React Hook Form + Zod validation [Source: architecture/tech-stack.md]
- Bilingual support: Arabic/English labels using next-i18next [Source: architecture/tech-stack.md]
- Styling: Tailwind CSS with RTL support [Source: architecture/tech-stack.md]
- UI components: shadcn/ui + Headless UI for accessibility [Source: architecture/tech-stack.md]

**Component Structure**:
- `CashAccountForm.tsx` - Cash account creation and editing
- `BankAccountForm.tsx` - Bank account creation with bank details
- `AccountList.tsx` - Display cash and bank accounts with actions
- `BalanceAdjustmentForm.tsx` - Balance update with reason tracking
- `BalanceHistoryModal.tsx` - View balance change audit trail
- `DefaultAccountSelector.tsx` - Set default payment account per shop

### File Locations
**Based on Project Structure** [Source: architecture/unified-project-structure.md]:
- API endpoints: `apps/api/src/server/routers/cash-bank.ts` (new router)
- Database repositories: `apps/api/src/server/db/repositories/cashAccount.ts` and `bankAccount.ts`
- Database services: `apps/api/src/server/services/balance-history.service.ts`
- Frontend components: `apps/web/src/components/admin/cash-bank/`
- Type definitions: `packages/shared/src/types/cashBankAccount.ts`
- Validation schemas: `packages/shared/src/validators/cashBankAccount.ts`
- Prisma migration: `apps/api/prisma/migrations/` for new models

### Testing Requirements
**Testing Strategy** [Source: architecture/testing-strategy.md]:
- Frontend tests: `apps/web/tests/unit/components/` and `apps/web/tests/integration/`
- API tests: Using Vitest + Supertest for endpoint testing at `apps/api/tests/unit/routers/`
- E2E tests: `apps/web/tests/e2e/` using Playwright with Arabic text support
- All tests must include bilingual interface testing (Arabic/English)
- Mobile responsiveness testing required
- Test negative balance scenarios (overdraft support)

**Specific Test Cases Required**:
- Cash account creation with positive and negative opening balances
- Bank account creation with IBAN validation
- Multiple bank accounts per shop management
- Default payment account selection (only one per shop)
- Balance history audit trail verification
- Bilingual form validation and submission testing

### Technical Constraints
**Multi-tenant Isolation** [Source: architecture/coding-standards.md]:
- Every database query must include shopId filtering
- All API routes must use standard error handler middleware
- Never mutate state directly - use proper state management patterns
- Only one default payment account per shop (unique constraint)

**Type Safety** [Source: architecture/coding-standards.md]:
- Always define types in packages/shared and import from there
- Never make direct HTTP calls - always use tRPC client service layer
- Access environment variables only through config objects

**Arabic Support** [Source: architecture/coding-standards.md]:
- All user-facing strings must have Arabic translations
- RTL layout support in Tailwind CSS
- Arabic bank name and account name support

**Financial Data Precision** [From previous stock value story patterns]:
- Use @db.Decimal(15, 2) for all monetary values
- Handle negative balances for overdraft accounts
- Maintain audit trail for all balance changes

### Technology Stack
**Backend**: TypeScript + Next.js API Routes + tRPC + Prisma + PostgreSQL [Source: architecture/tech-stack.md]
**Frontend**: TypeScript + Next.js + Headless UI + shadcn/ui + Zustand [Source: architecture/tech-stack.md]
**Validation**: React Hook Form + Zod for type-safe form validation [Source: architecture/tech-stack.md]
**Internationalization**: next-i18next for Arabic/English support [Source: architecture/tech-stack.md]

## Testing
**Test Organization** [Source: architecture/testing-strategy.md]:
- Unit tests: `apps/web/tests/unit/components/` for UI components
- Integration tests: `apps/web/tests/integration/api/` for API endpoint testing
- E2E tests: `apps/web/tests/e2e/` using Playwright framework
- Testing frameworks: Vitest + React Testing Library for frontend, Vitest + Supertest for backend
- All tests must include Arabic interface testing and mobile responsiveness
- Specific test requirement: Bilingual form validation and negative balance handling

**Test Coverage Requirements**:
- Cash account CRUD operations with balance validation
- Bank account creation with IBAN validation and bank details
- Balance history tracking and audit trail verification
- Default payment account selection with unique constraint testing
- Multi-tenant isolation verification across all operations

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-17 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
No critical debug issues encountered during implementation.

### Completion Notes List
- Successfully implemented all cash and bank account models with proper multi-tenant isolation
- Added comprehensive API endpoints with tRPC type safety
- Created full admin interface with bilingual support (Arabic/English) and RTL layout
- Implemented balance history tracking with audit trail
- Added support for negative balances (overdraft scenarios)
- Ensured proper validation and error handling throughout
- Created comprehensive test suite covering unit, integration, and E2E tests

### File List
- **Database Schema**: `apps/api/prisma/schema.prisma` (updated with CashAccount, BankAccount, BalanceHistory models)
- **Types**: `packages/shared/src/types/cashBankAccount.ts`
- **Validators**: `packages/shared/src/validators/cashBankAccount.ts`
- **Repositories**:
  - `apps/api/src/server/db/repositories/cashAccount.ts`
  - `apps/api/src/server/db/repositories/bankAccount.ts`
- **Services**: `apps/api/src/server/services/balance-history.service.ts`
- **tRPC Router**: `apps/api/src/server/routers/cash-bank.ts`
- **Main Router**: `apps/api/src/server/routers/index.ts` (updated)
- **Frontend Components**:
  - `apps/web/src/components/features/cash-bank/CashAccountForm.tsx`
  - `apps/web/src/components/features/cash-bank/BankAccountForm.tsx`
  - `apps/web/src/components/features/cash-bank/AccountList.tsx`
  - `apps/web/src/components/features/cash-bank/BalanceAdjustmentForm.tsx`
  - `apps/web/src/components/features/cash-bank/BalanceHistoryModal.tsx`
  - `apps/web/src/components/features/cash-bank/CashBankManagement.tsx`
  - `apps/web/src/components/features/cash-bank/index.ts`
- **UI Components** (added):
  - `apps/web/src/components/ui/label.tsx`
  - `apps/web/src/components/ui/textarea.tsx`
  - `apps/web/src/components/ui/tabs.tsx`
  - `apps/web/src/components/ui/table.tsx`
- **Utilities**: `apps/web/src/lib/utils.ts` (updated with formatCurrency, formatDate)
- **Hooks**: `apps/web/src/hooks/use-toast.ts`
- **Tests**:
  - `apps/api/tests/unit/routers/cashBank.test.ts`
  - `apps/web/tests/e2e/cashBankManagement.spec.ts`
  - `apps/web/tests/integration/components/CashAccountForm.test.tsx`

## QA Results

### Review Date: 2025-09-17

### Reviewed By: Quinn (Test Architect)

**Acceptance Criteria Coverage**: All 8 acceptance criteria have been fully implemented and verified:

1. ✅ **Cash account creation per shop with opening balance** - Implemented via CashAccount model with proper shopId isolation and Decimal precision for balances
2. ✅ **Bank account creation per shop with opening balance** - Implemented via BankAccount model with full bank details support
3. ✅ **Multiple bank accounts per shop support** - Proper many-to-one relationship with Shop model established
4. ✅ **Account number and bank details storage** - Full bank account details including accountNumber, bankName, and optional IBAN
5. ✅ **Opening balance validation (can be negative for overdraft)** - Zod validation allows negative numbers, Decimal type supports precision
6. ✅ **Balance history tracking** - BalanceHistory model with comprehensive audit trail implementation
7. ✅ **Account reconciliation markers** - Reconciliation status tracking implemented in balance history
8. ✅ **Default payment account selection per shop** - Unique constraint ensures only one default account per shop

**Implementation Quality**: Excellent adherence to coding standards and architecture patterns:
- Multi-tenant isolation properly enforced with shopId filtering in all operations
- Type safety maintained throughout with shared types and validators
- tRPC procedures follow established patterns with proper error handling
- Repository pattern consistently applied for data access
- Bilingual support (Arabic/English) implemented in UI components
- RTL layout support for Arabic interface

**Testing Coverage**: Comprehensive test suite covering all critical scenarios:
- Unit tests for tRPC router endpoints (apps/api/tests/unit/routers/cashBank.test.ts)
- Integration tests for form components (apps/web/tests/integration/components/CashAccountForm.test.tsx)
- E2E tests for complete workflow (apps/web/tests/e2e/cashBankManagement.spec.ts)
- Tests cover both positive and negative balance scenarios
- Bilingual interface testing included

**Security Assessment**: Proper security measures implemented:
- Admin-only procedures for account creation/modification using adminProcedure
- Multi-tenant isolation enforced at database level
- Input validation via Zod schemas prevents injection attacks
- No sensitive information exposed in error messages

**Performance Considerations**: Well-optimized database design:
- Proper indexing on shopId for multi-tenant queries
- Decimal precision for financial calculations (15,2)
- Efficient relationship modeling with cascade deletes

### Gate Status

Gate: PASS → docs/qa/gates/2.5-cash-bank-account-setup.yml