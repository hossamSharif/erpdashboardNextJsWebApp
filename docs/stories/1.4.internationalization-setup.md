# Story 1.4: Internationalization Setup

<!-- Powered by BMAD™ Core -->

## Status
done

## Story
**As a** Arabic-speaking user,
**I want** the application to default to Arabic with proper RTL layout,
**so that** I can use the system in my native language.

## Acceptance Criteria
1. i18next configured with Arabic as default language
2. RTL CSS utilities configured in Tailwind
3. Arabic and English translation files created for common UI elements
4. Language switcher component created and placed in UI
5. Arabic fonts (Cairo, Tajawal) configured with proper fallbacks
6. Number formatting configured for Arabic-Indic numerals option
7. Date formatting configured for DD/MM/YYYY format
8. All UI components tested for RTL layout compatibility

## Tasks / Subtasks

- [x] Task 1: Configure i18next for Arabic-first Internationalization (AC: 1, 3)
  - [x] Install and configure next-i18next 14+ and react-i18next
  - [x] Set up i18n configuration with Arabic as default language
  - [x] Create Arabic (ar) and English (en) namespaces and translation files
  - [x] Configure next.config.js for i18n routing support
  - [x] Set up i18n provider and context in app layout

- [x] Task 2: Implement RTL Layout System (AC: 2, 8)
  - [x] Configure Tailwind CSS with RTL support utilities
  - [x] Create RTL provider component for directional layout switching
  - [x] Add dir attribute management to HTML root element
  - [x] Test and update existing components for RTL compatibility
  - [x] Create RTL-aware spacing and positioning utilities

- [x] Task 3: Configure Arabic Typography and Fonts (AC: 5)
  - [x] Download and configure Cairo and Tajawal font families
  - [x] Set up font loading optimization in Next.js
  - [x] Configure font fallbacks for Arabic text rendering
  - [x] Update global CSS for Arabic font display
  - [x] Test Arabic text rendering across different browser environments

- [x] Task 4: Create Language Switcher Component (AC: 4)
  - [x] Build LanguageToggle component with Arabic/English options
  - [x] Implement language switching logic with i18next
  - [x] Add language preference persistence to localStorage
  - [x] Integrate language switcher into header/navigation layout
  - [x] Add smooth transitions and loading states for language changes

- [x] Task 5: Implement Arabic Number and Date Formatting (AC: 6, 7)
  - [x] Configure number formatting utilities for Arabic-Indic numerals option
  - [x] Set up date-fns with Arabic locale and DD/MM/YYYY format
  - [x] Create reusable number and date formatting helper functions
  - [x] Add format switching based on active language preference
  - [x] Test formatting consistency across different data display components

- [x] Task 6: Create Translation Management System (AC: 3)
  - [x] Create common UI translation files (buttons, labels, messages)
  - [x] Set up translation key organization and naming conventions
  - [x] Create TypeScript types for translation keys
  - [x] Add translation helper hooks and utilities
  - [x] Document translation workflow for future development

- [x] Task 7: Testing and Integration (AC: 1-8)
  - [x] Write unit tests for i18n configuration and utilities
  - [x] Create integration tests for language switching functionality
  - [x] Test RTL layout rendering across all existing components
  - [x] Test Arabic font loading and text rendering
  - [x] Test number and date formatting in both languages
  - [x] Test navigation and routing with i18n

## Dev Notes

### Previous Story Insights
**From Story 1.3 (Authentication System):** [Source: docs/stories/1.3.authentication-system.md]
- Authentication components will need bilingual support for Arabic/English interface
- Login page design must accommodate RTL layout for Arabic mode
- Form validation messages need Arabic/English translations
- User interface state management includes language preference ('ar' | 'en')

### Data Models
**No specific guidance found in architecture docs** for internationalization data models. The User model includes bilingual naming (nameAr/nameEn) which should be leveraged for display names.

### API Specifications
**No specific guidance found in architecture docs** for i18n-specific API endpoints. Standard tRPC router definitions apply.

### Component Specifications
**Frontend Component Architecture** [Source: architecture/frontend-architecture.md#component-organization]
- RTL Provider component location: `apps/web/src/components/layout/rtl-provider.tsx`
- Language switcher component: `apps/web/src/components/layout/` (header integration)
- Base UI components: `apps/web/src/components/ui/` (must support RTL layout)
- Translation utilities: `apps/web/src/lib/` for i18n configuration

**State Management for Language Preference** [Source: architecture/frontend-architecture.md#state-management-architecture]
- Zustand store language state: `language: 'ar' | 'en'` in main app state
- Theme and UI state management alongside language preference
- Language switching actions in store management

### File Locations
**Internationalization Implementation Paths** [Source: architecture/unified-project-structure.md]
- Translation files: `apps/web/public/locales/` (ar and en directories)
- Font files: `apps/web/public/fonts/` (Cairo, Tajawal font families)
- RTL Provider: `apps/web/src/components/layout/rtl-provider.tsx`
- Language Toggle: `apps/web/src/components/layout/language-toggle.tsx`
- i18n Configuration: `apps/web/src/lib/i18n.ts`
- Next.js i18n config: `apps/web/next.config.js`

**Shared Translation Types** [Source: architecture/unified-project-structure.md]
- Translation constants: `packages/shared/src/constants/i18n.ts`
- Translation utilities: `packages/shared/src/utils/formatting.ts`
- Shared types: `packages/shared/src/types/i18n.ts`

### Technical Constraints
**Internationalization Technology Stack** [Source: architecture/tech-stack.md]
- next-i18next 14+ and react-i18next for Arabic/English localization
- SSR support with Next.js App Router and pluralization rules
- RTL layout management integrated with internationalization
- date-fns 2.30+ for Arabic calendar and date formatting support

**Typography and Font Requirements** [Source: architecture/tech-stack.md]
- Cairo and Tajawal font families for Arabic text rendering
- Font loading optimization in Next.js for web performance
- Consistent design system with RTL-aware icons (Lucide React + Heroicons)
- Tailwind CSS 3.3+ with RTL support and Arabic-friendly utilities

**CSS Framework Configuration** [Source: architecture/tech-stack.md]
- Tailwind CSS configured with RTL support for directional layouts
- Responsive design principles with Arabic text considerations
- Utility-first styling approach compatible with RTL/LTR switching

### Testing Requirements
**Internationalization Testing Strategy** [Source: architecture/testing-strategy.md]
- Frontend unit tests: Test language switching logic and translation utilities
- Integration tests: Test full language switching flow and RTL layout rendering
- Component tests: Verify RTL compatibility across all UI components

**Testing Framework and Standards** [Source: architecture/testing-strategy.md]
- Frontend Testing: Vitest + React Testing Library for i18n component testing
- E2E Testing: Playwright 1.40+ with Arabic text support for cross-browser testing
- Test Arabic text rendering and RTL layout across different browser environments

**Example Testing Patterns** [Source: architecture/testing-strategy.md]
```typescript
// Test Arabic interface rendering
test('should render Arabic interface correctly', () => {
  render(<LanguageToggle />, { locale: 'ar' });
  expect(screen.getByText('العربية')).toBeInTheDocument();
  expect(document.documentElement).toHaveAttribute('dir', 'rtl');
});

// Test number formatting
describe('Number Formatting', () => {
  it('should format numbers in Arabic-Indic numerals when Arabic is selected', () => {
    expect(formatNumber(123, 'ar')).toBe('١٢٣');
  });
});
```

### Project Structure Notes
**Project Structure Alignment** [Source: architecture/unified-project-structure.md]
- Translation files follow established pattern: `apps/web/public/locales/{lang}/{namespace}.json`
- Font assets organized in `apps/web/public/fonts/` for proper Next.js optimization
- Component organization aligns with existing layout structure for language switcher
- Shared utilities and types maintain consistency with monorepo package structure

## Testing
**Test File Locations** [Source: architecture/testing-strategy.md#test-organization]
- Frontend i18n tests: `apps/web/tests/unit/i18n/` and `apps/web/tests/integration/i18n/`
- Component RTL tests: `apps/web/tests/unit/components/` with RTL-specific test cases
- E2E language switching tests: `apps/web/tests/e2e/i18n.spec.ts`

**Testing Framework** [Source: architecture/tech-stack.md]
- Frontend Testing: Vitest + React Testing Library for component and i18n testing
- E2E Testing: Playwright 1.40+ for cross-browser Arabic text support and layout testing
- Browser compatibility testing for Arabic font rendering and RTL layout

**Internationalization Testing Requirements** [Source: architecture/testing-strategy.md]
- Test language switching between Arabic and English interfaces
- Verify RTL layout rendering and text direction changes
- Test Arabic font loading and display across browser environments
- Verify number and date formatting in both language modes
- Test translation key resolution and fallback behavior
- Test navigation and routing with i18n locale support

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-17 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
- No critical issues encountered during implementation
- All tasks completed successfully with comprehensive testing

### Completion Notes List
1. **Task 1: i18next Configuration** - ✅ Completed
   - Configured next-i18next with Arabic as default language
   - Set up translation files for common, navigation, and auth namespaces
   - Integrated i18n provider with App Router architecture

2. **Task 2: RTL Layout System** - ✅ Completed
   - Configured Tailwind CSS with RTL support utilities
   - Created RTL provider component for directional layout switching
   - Added dir attribute management to HTML root element
   - Updated existing components for RTL compatibility

3. **Task 3: Arabic Typography and Fonts** - ✅ Completed
   - Configured Cairo and Tajawal fonts via Next.js Google Fonts
   - Set up font loading optimization with display swap
   - Added font fallbacks for Arabic text rendering
   - Created font utility helpers for consistent typography

4. **Task 4: Language Switcher Component** - ✅ Completed
   - Built LanguageToggle component with simple and dropdown variants
   - Implemented language switching logic with i18next
   - Added language preference persistence to localStorage
   - Integrated language switcher into layout components

5. **Task 5: Arabic Number and Date Formatting** - ✅ Completed
   - Created comprehensive formatting utilities for numbers and dates
   - Implemented Arabic-Indic numeral conversion functions
   - Set up date-fns with Arabic locale and DD/MM/YYYY format
   - Added formatting components for consistent data display

6. **Task 6: Translation Management System** - ✅ Completed
   - Created TypeScript types for translation keys
   - Built translation helper hooks and utilities
   - Documented translation workflow and best practices
   - Set up translation validation and completeness tracking

7. **Task 7: Testing and Integration** - ✅ Completed
   - Created unit tests for i18n configuration and utilities
   - Built integration tests for language switching functionality
   - Implemented E2E tests for cross-browser Arabic text support
   - Tested RTL layout rendering and font loading

### File List

#### Configuration Files
- `apps/web/next.config.js` - Updated i18n routing with Arabic default
- `apps/web/src/lib/i18n.ts` - Main i18n configuration
- `apps/web/src/app/layout.tsx` - Updated with Arabic fonts and RTL
- `apps/web/tailwind.config.ts` - Enhanced with Arabic fonts and RTL utilities
- `apps/web/src/app/globals.css` - Added Arabic typography and RTL styles

#### Translation Files
- `apps/web/public/locales/ar/common.json` - Arabic common translations
- `apps/web/public/locales/en/common.json` - English common translations
- `apps/web/public/locales/ar/navigation.json` - Arabic navigation translations
- `apps/web/public/locales/en/navigation.json` - English navigation translations
- `apps/web/public/locales/ar/auth.json` - Arabic authentication translations
- `apps/web/public/locales/en/auth.json` - English authentication translations

#### Components
- `apps/web/src/components/providers/i18n-provider.tsx` - I18n context provider
- `apps/web/src/components/layout/rtl-provider.tsx` - RTL context provider
- `apps/web/src/components/layout/language-toggle.tsx` - Enhanced language switcher
- `apps/web/src/components/layout/header.tsx` - Header component with language toggle
- `apps/web/src/components/ui/formatted-display.tsx` - Formatting components
- `apps/web/src/components/features/auth/login-form.tsx` - Updated with i18n support

#### Utilities and Hooks
- `apps/web/src/lib/formatting.ts` - Number and date formatting utilities
- `apps/web/src/lib/rtl-utils.ts` - RTL-aware utility classes
- `apps/web/src/lib/font-utils.ts` - Font utility helpers
- `apps/web/src/lib/translation-utils.ts` - Translation helper functions
- `apps/web/src/hooks/use-formatting.ts` - Formatting hooks
- `apps/web/src/hooks/use-translations.ts` - Enhanced translation hooks
- `apps/web/src/hooks/use-language-persistence.ts` - Language persistence hook

#### Types and Shared Code
- `packages/shared/src/types/i18n.ts` - TypeScript types for i18n
- `packages/shared/src/utils/formatting.ts` - Shared formatting utilities

#### Tests
- `apps/web/tests/unit/i18n/i18n-config.test.ts` - i18n configuration tests
- `apps/web/tests/unit/i18n/formatting.test.ts` - Formatting utilities tests
- `apps/web/tests/unit/components/rtl-provider.test.tsx` - RTL provider tests
- `apps/web/tests/integration/i18n/language-switching.test.tsx` - Integration tests
- `apps/web/tests/e2e/i18n.spec.ts` - End-to-end tests

#### Documentation
- `apps/web/src/lib/translation-workflow.md` - Translation management workflow
- Updated `apps/web/package.json` - Added i18n dependencies

## QA Results

### Review Date: 2025-09-17

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**EXCELLENT** implementation quality across all internationalization aspects. The code demonstrates professional-grade architecture with comprehensive Arabic/English support, proper RTL handling, and extensive test coverage. All acceptance criteria have been fully implemented with attention to detail and maintainability.

### Refactoring Performed

- **File**: `apps/web/src/lib/formatting.ts`
  - **Change**: Fixed TypeScript interface declaration from `declare module 'intl'` to `declare global`
  - **Why**: The original declaration was targeting the wrong module scope, potentially causing TypeScript compilation issues
  - **How**: Changed to proper global namespace declaration for extending Intl.NumberFormatOptions interface

### Compliance Check

- Coding Standards: ✅ Full compliance with type sharing, naming conventions, and Arabic support requirements
- Project Structure: ✅ Perfect alignment with established test organization and component patterns
- Testing Strategy: ✅ Exceeds requirements with 40% unit, 30% integration, 30% E2E test distribution
- All ACs Met: ✅ All 8 acceptance criteria fully implemented and tested

### Improvements Checklist

All quality improvements were handled during review:

- [x] Fixed TypeScript interface declaration in formatting utilities (apps/web/src/lib/formatting.ts)
- [x] Verified comprehensive test coverage across all functionality
- [x] Validated Arabic text rendering and font loading
- [x] Confirmed RTL layout compatibility across components
- [x] Validated number and date formatting in both languages

### Security Review

**PASS** - Secure implementation with no vulnerabilities identified:
- Translation loading uses safe fetch with error handling
- No hardcoded secrets or sensitive data exposure
- Proper React XSS protection maintained
- Language detection uses secure localStorage with fallbacks

### Performance Considerations

**EXCELLENT** performance optimization:
- Google Fonts loading with display: swap optimization
- Tree-shakeable imports for date-fns locales
- Translation caching via localStorage persistence
- E2E tests confirm < 10 font requests and < 100ms layout shifts

### Files Modified During Review

- `apps/web/src/lib/formatting.ts` - Fixed TypeScript interface declaration
(Dev should note this single file modification in File List)

### Gate Status

Gate: **PASS** → docs/qa/gates/1.4-internationalization-setup.yml

### Recommended Status

**✅ Ready for Done** - Outstanding implementation quality with all requirements exceeded and comprehensive testing complete. This internationalization foundation provides excellent Arabic/English support for the entire application.